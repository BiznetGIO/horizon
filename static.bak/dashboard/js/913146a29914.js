(function(){'use strict';angular.module('horizon.app.core.images').controller('horizon.app.core.images.steps.UpdateMetadataController',UpdateMetadataController);UpdateMetadataController.$inject=['$scope','$q','horizon.app.core.images.events','horizon.app.core.metadata.service','horizon.framework.widgets.metadata.tree.service'];function UpdateMetadataController($scope,$q,events,metadataService,metadataTreeService){var ctrl=this;ctrl.tree=new metadataTreeService.Tree([],[]);$scope.$watchCollection(getTree,onMetadataChanged);if($scope.imagePromise){$scope.imagePromise.then(init);}else{$q.all({available:metadataService.getNamespaces('image'),existing:getExistingMetdataPromise({})}).then(onMetadataGet);}
function init(response){var image=response.data;$q.all({available:metadataService.getNamespaces('image'),existing:getExistingMetdataPromise(image)}).then(onMetadataGet);}
function onMetadataGet(response){ctrl.tree=new metadataTreeService.Tree(response.available.data.items,response.existing.data);}
function getTree(){return ctrl.tree.getExisting();}
function getExistingMetdataPromise(image){if(angular.isDefined(image.id)){return metadataService.getMetadata('image',image.id);}else{var deferred=$q.defer();deferred.resolve({data:[]});return deferred.promise;}}
function onMetadataChanged(newValue,oldValue){if(newValue!==oldValue){$scope.$emit(events.IMAGE_METADATA_CHANGED,newValue);}}}})();