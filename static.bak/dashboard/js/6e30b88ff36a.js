(function(){'use strict';var extend=angular.extend;var forEach=angular.forEach;angular.module('horizon.framework.widgets.wizard').controller('WizardController',WizardController);WizardController.$inject=['$scope','$q','horizon.framework.widgets.wizard.labels','horizon.framework.widgets.wizard.events'];function WizardController($scope,$q,wizardLabels,wizardEvents){var viewModel=$scope.viewModel={};var initTask=$q.defer();$scope.initPromise=initTask.promise;$scope.currentIndex=-1;$scope.workflow=$scope.workflow||{};if($scope.workflow.initControllers){$scope.workflow.initControllers($scope);}
var steps=$scope.steps=$scope.workflow.steps||[];$scope.wizardForm={};$scope.stepModels={};$scope.switchTo=switchTo;$scope.showError=showError;viewModel.btnText=extend({},wizardLabels,$scope.workflow.btnText);viewModel.btnIcon=$scope.workflow.btnIcon||{};viewModel.showSpinner=false;viewModel.hasError=false;viewModel.onClickFinishBtn=onClickFinishBtn;viewModel.isSubmitting=false;$scope.initPromise.then(onInitSuccess,onInitError);checkAllReadiness().then(always,always);function switchTo(index){$scope.$broadcast(wizardEvents.ON_SWITCH,{from:$scope.currentIndex,to:index});toggleHelpBtn(index);$scope.currentIndex=index;$scope.openHelp=false;}
function showError(errorMessage){viewModel.showSpinner=false;viewModel.hasError=true;if(errorMessage&&angular.isString(errorMessage.data)){viewModel.errorMessage=errorMessage.data;}else{viewModel.errorMessage=errorMessage;}
viewModel.isSubmitting=false;}
function beforeSubmit(){$scope.$broadcast(wizardEvents.BEFORE_SUBMIT);}
function afterSubmit(args){$scope.$broadcast(wizardEvents.AFTER_SUBMIT);$scope.close(args);}
function onClickFinishBtn(){viewModel.isSubmitting=true;beforeSubmit();$scope.submit($scope.stepModels).then(afterSubmit,showError);}
function onInitSuccess(){$scope.$broadcast(wizardEvents.ON_INIT_SUCCESS);if(steps.length>0){toggleHelpBtn(0);}}
function onInitError(){$scope.$broadcast(wizardEvents.ON_INIT_ERROR);}
function toggleHelpBtn(index){if(angular.isUndefined(steps[index].helpUrl)){$scope.hideHelpBtn=true;}else{$scope.hideHelpBtn=false;}}
function checkAllReadiness(){var stepReadyPromises=[];forEach(steps,function(step,index){step.ready=!step.checkReadiness;if(step.checkReadiness){var promise=step.checkReadiness();stepReadyPromises.push(promise);promise.then(function(){step.ready=true;},function(){$scope.steps.splice(index,1);});}});viewModel.ready=stepReadyPromises.length===0;return $q.all(stepReadyPromises);}
function switchToFirstReadyStep(){forEach(steps,function(step,index){if($scope.currentIndex<0&&step.ready){$scope.currentIndex=index;return;}});}
function always(){initTask.resolve();viewModel.ready=true;switchToFirstReadyStep();}}})();