horizon.networktopologycommon={init:function(){horizon.networktopologyloader.init();horizon.networktopologymessager.init();}};horizon.networktopologyloader={model:null,reload_duration:10000,update_timer:null,init:function(){var self=this;if($('#networktopology').length===0){return;}
self.update();},update:function(){var self=this;angular.element.getJSON(angular.element('#networktopology').data('networktopology')+'?'+angular.element.now(),function(data){self.model=data;$('#networktopology').trigger('change');self.update_timer=setTimeout(function(){self.update();},self.reload_duration);});},stop_update:function(){var self=this;clearTimeout(self.update_timer);},setup_loader:function($container){return horizon.loader.inline(gettext('Loading')).hide().prependTo($container);}};horizon.networktopologymessager={previous_message:null,post_messages:'#topologyMessages',messaging_functions:[],delete_data:{},init:function(){var self=this;angular.element(window).on('message',function(e){var message=angular.element.parseJSON(e.originalEvent.data);if(self.previous_message!==message.message){horizon.toast.add(message.type,message.message);self.previous_message=message.message;self.delete_post_message(message.iframe_id);self.messageNotify(message);horizon.networktopologyloader.update();setTimeout(function(){self.previous_message=null;self.delete_data={};},self.reload_duration);}});},addMessageHandler:function(fn,fnObj){var self=this;self.messaging_functions.push({obj:fnObj,func:fn});},messageNotify:function(message){var self=this;for(var i=0;i<self.messaging_functions.length;i+=1){func=self.messaging_functions[i].func;fnObj=self.messaging_functions[i].obj;func.call(fnObj,message);}},post_message:function(id,url,message,type,action,data){var self=this;if(action=="delete"){self.delete_data.device_id=id;self.delete_data.device_type=type;self.delete_data.device_data=data;}
horizon.networktopologyloader.stop_update();var iframeID='ifr_'+id;var iframe=$('<iframe width="500" height="300" />').attr('id',iframeID).attr('src',url).appendTo('#topologyMessages');iframe.on('load',function(){angular.element(this).get(0).contentWindow.postMessage(JSON.stringify(message,null,2),'*');});},delete_post_message:function(id){angular.element('#'+id).remove();}};