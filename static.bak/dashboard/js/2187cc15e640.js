horizon.Quota={is_flavor_quota:false,user_value_progress_bars:[],auto_value_progress_bars:[],flavor_progress_bars:[],user_value_form_inputs:[],selected_flavor:null,flavors:[],init:function(){this.user_value_progress_bars=$('div[data-progress-indicator-for]');this.auto_value_progress_bars=$('div[data-progress-indicator-step-by]');this.user_value_form_inputs=$($.map(this.user_value_progress_bars,function(elm){return('#'+$(elm).attr('data-progress-indicator-for'));}));this._attachInputHandlers();},belowMinimum:function(minimum,actual){return parseInt(minimum,10)>parseInt(actual,10);},imageFitsFlavor:function(image,flavor){if(image===undefined){return true;}else{var overDisk=horizon.Quota.belowMinimum(image.min_disk,flavor.disk);var overRAM=horizon.Quota.belowMinimum(image.min_ram,flavor.ram);return!(overDisk||overRAM);}},noteDisabledFlavors:function(allDisabled){if($('#some_flavors_disabled').length===0){var message=allDisabled?horizon.Quota.allFlavorsDisabledMessage:horizon.Quota.disabledFlavorMessage;$('#id_flavor').parent().append("<span id='some_flavors_disabled'>"+
message+'</span>');}},resetFlavors:function(){if($('#some_flavors_disabled')){$('#some_flavors_disabled').remove();$('#id_flavor option').each(function(){$(this).attr('disabled',false);});}},findImageById:function(id){var _image;$.each(horizon.Quota.images,function(i,image){if(image.id===id){_image=image;}});return _image;},getSelectedImageOrSnapshot:function(source_type){var selected=$('#id_'+source_type+'_id option:selected').val();return horizon.Quota.findImageById(selected);},disableFlavorsForImage:function(source_type){var source=horizon.Quota.getSelectedImageOrSnapshot(source_type);var to_disable=[];horizon.Quota.resetFlavors();$.each(horizon.Quota.flavors,function(i,flavor){if(!horizon.Quota.imageFitsFlavor(source,flavor)){to_disable.push(flavor.name);}});var flavors=$('#id_flavor option');$.each(to_disable,function(i,flavor_name){flavors.each(function(){if($(this).text()===flavor_name){$(this).attr('disabled','disabled');}});});if(to_disable.length>0){var selected=($('#id_flavor option').filter(':selected'))[0];if(to_disable.length<flavors.length&&selected.disabled){flavors.each(function(index,element){if(!element.disabled){$('#id_flavor').val(element.value);$('#id_flavor').change();return false;}});}
horizon.Quota.noteDisabledFlavors(to_disable.length===flavors.length);}},initWithImages:function(images,disabledMessage,allDisabledMessage){this.images=images;this.disabledFlavorMessage=disabledMessage;this.allFlavorsDisabledMessage=allDisabledMessage;horizon.Quota.disableFlavorsForImage('image');},initWithFlavors:function(flavors){this.is_flavor_quota=true;this.flavor_progress_bars=$('div[data-progress-indicator-flavor]');this.flavors=flavors;this.init();this.showFlavorDetails();this.updateFlavorUsage();},getSelectedFlavor:function(){if(this.is_flavor_quota){this.selected_flavor=$.grep(this.flavors,function(flavor){return flavor.id===$("#id_flavor").children(":selected").val();})[0];this.old_flavor=$.grep(this.flavors,function(flavor){return flavor.name===$('#id_old_flavor_name').val();})[0];}else{this.old_flavor=null;this.selected_flavor=null;}
return this.selected_flavor;},showFlavorDetails:function(){this.getSelectedFlavor();if(this.selected_flavor){var vcpus=horizon.Quota.humanizeNumbers(this.selected_flavor.vcpus);var disk=horizon.Quota.humanizeNumbers(this.selected_flavor.disk);var ephemeral=horizon.Quota.humanizeNumbers(this.selected_flavor["OS-FLV-EXT-DATA:ephemeral"]);var disk_total=this.selected_flavor.disk+this.selected_flavor["OS-FLV-EXT-DATA:ephemeral"];var disk_total_display=horizon.Quota.humanizeNumbers(disk_total);var ram=horizon.Quota.humanizeNumbers(this.selected_flavor.ram);$("#flavor_name").text(this.selected_flavor.name);$("#flavor_vcpus").text(vcpus);$("#flavor_disk").text(disk);$("#flavor_ephemeral").text(ephemeral);$("#flavor_disk_total").text(disk_total_display);$("#flavor_ram").text(ram);}
else{$("#flavor_name").html('');$("#flavor_vcpus").text('');$("#flavor_disk").text('');$("#flavor_ephemeral").text('');$("#flavor_disk_total").text('');$("#flavor_ram").text('');}},humanizeNumbers:function(number){return number.toString().replace(/\d+(?:\.\d+)?/g,function(match){var lang=horizon.cookies.get('horizon_language');try{return new Intl.NumberFormat(lang).format(match);}catch(e){return match;}});},updateFlavorUsage:function(){if(!this.is_flavor_quota){return;}
var scope=this;var instance_count=(parseInt($("#id_count").val(),10)||1);var update_amount=0;this.getSelectedFlavor();$(this.flavor_progress_bars).each(function(index,element){var element_id=$(element).attr('id');var progress_stat=element_id.match(/^quota_(.+)/)[1];var sourceType=$("#id_source_type").val();var createVolume=(sourceType==="volume_snapshot_id"||sourceType==="volume_image_id");if(!progress_stat){return;}else if(progress_stat==='resize_instance'){update_amount=0;}else if(progress_stat==='instances'){update_amount=instance_count;}else if(progress_stat==='vcpus'&&scope.old_flavor&&scope.selected_flavor){var old_vcpus=scope.old_flavor.vcpus;var new_vcpus=scope.selected_flavor.vcpus;update_amount=(new_vcpus-old_vcpus<0)?0:(new_vcpus-old_vcpus);}else if(progress_stat==='ram'&&scope.old_flavor&&scope.selected_flavor){var old_ram=scope.old_flavor.ram;var new_ram=scope.selected_flavor.ram;update_amount=(new_ram-old_ram<0)?0:(new_ram-old_ram);}else if(progress_stat==="volume"){update_amount=createVolume?instance_count:0;}else if(progress_stat==="volume_storage"){var volumeSize=0;if(sourceType==="volume_snapshot_id"){var volumeSizeMatches=$("#id_volume_snapshot_id").children(":selected").html().match(/\s(\d+)\s/g);volumeSize=horizon.Quota.getSelectedFlavor().disk;if(volumeSizeMatches){volumeSize=Math.max(volumeSize,volumeSizeMatches[volumeSizeMatches.length-1]);}}else if(sourceType==="volume_image_id"){volumeSize=$("#id_volume_size").val();}
update_amount=volumeSize*instance_count;}else if(scope.selected_flavor){update_amount=(scope.selected_flavor[progress_stat]*instance_count);}
scope.updateUsageFor(element,update_amount);});},updateUsageFor:function(progress_element,increment_by){var $progress_element=$(progress_element);var quota_limit=parseInt($progress_element.attr('data-quota-limit'),10);var percentage_to_update=((increment_by/quota_limit)*100);this.update($progress_element.attr('id'),percentage_to_update);},update:function(element,value){var bars=$('#'+element).find('.progress-bar');var used_val=+$(bars[0]).attr('aria-valuenow');var total=used_val+value;if(total>100){value=100-used_val;}
var percent_str=value+'%';var $bar=$(bars[1]);$bar.css('width',percent_str).attr('aria-valuenow',value).find('.sr-only').html(percent_str);if(total>99){$bar.removeClass('progress-bar-warning').addClass('progress-bar-danger');}else{$bar.removeClass('progress-bar-danger');total>89?$bar.addClass('progress-bar-warning'):$bar.removeClass('progress-bar-warning');}},_attachInputHandlers:function(){var scope=this;if(this.is_flavor_quota){var eventCallback=function(){scope.showFlavorDetails();scope.updateFlavorUsage();};var imageChangeCallback=function(){scope.disableFlavorsForImage('image');};var snapshotChangeCallback=function(){scope.disableFlavorsForImage('instance_snapshot');};var volumeChangeCallback=function(){scope.updateFlavorUsage();};$('#id_flavor').on('keyup change',eventCallback);$('#id_count').on('input',eventCallback);$('#id_image_id').on('change',imageChangeCallback);$('#id_instance_snapshot_id').on('change',snapshotChangeCallback);$('#id_source_type').on('change',volumeChangeCallback);$('#id_volume_snapshot_id').on('change',volumeChangeCallback);$('#id_image_id').on('change',volumeChangeCallback);$('#id_volume_size').on('keyup change',volumeChangeCallback);}
$(this.user_value_form_inputs).each(function(index,element){$(element).on('input',function(){var $this=$(this);var $progress_element=$('div[data-progress-indicator-for='+$this.attr('id')+']');var integers_in_input=$this.val().match(/\d+/g);var user_integer;if(integers_in_input===null){user_integer=0;}else if(integers_in_input.length>1){user_integer=integers_in_input.join('');}else if(integers_in_input.length===1){user_integer=integers_in_input[0];}
var progress_amount=parseInt(user_integer,10);scope.updateUsageFor($progress_element,progress_amount);});});}};